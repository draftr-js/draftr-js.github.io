<!DOCTYPE html>
<html>

<head>
<title>draftr</title>
<script src="./js/lib/jquery-1.9.1.js"></script>
<script src="./js/lib/marked.js"></script>
<script src="./js/lib/yaml.js"></script>

<script src="./js/common.js"></script>
<script src="./js/from-md.js"></script>
<script src="./js/to-txt.js"></script>
<script src="./js/to-xml.js"></script>
<script>

var state = {
  mkd: null,
  xml: null,
  txt: null,
  name: null,
  timer: null
}

// Download the default document from here the first time
const DEFAULT_DOC_URL = 'https://ipv.sx/draftr-js.github.io/complete.md';
const SAVE_TIMEOUT    = 300;         // milliseconds to wait before saving
const CURRENT         = 'CURRENT';   // The current document ID
const DEFAULT_DOC     = 'DEFAULT';   // The default doc text
const DOC_PREFIX      = 'DOCUMENT-'; // before every doc ID.
const IS_DOC          = new RegExp('^' + DOC_PREFIX);

// localStorage model
// ['CURRENT']:      the ID of the document currently being edited
// ['DOCUMENT-'+ID]: the text of the document with the given ID
// ['DEFAULT']:      the text of the default doc.  cached for performance and
//                   offline access.

// Perform the transfrom from markdown(#in) to text(#out).
function xform() {
  var inp = $("#in").val();
  var outp = toXML(fromMD(inp));
  //var outp = JSON.stringify(fromMD(inp), null, 2);
  $("#out").val(outp);
}

// Save the doc.  If 'cur' is specified, this is a new doc, and we need
// to store its identifier.
function save(cur) {
  xform();
  if (cur) {
    localStorage[CURRENT] = cur;
  } else {
    cur = localStorage[CURRENT];
  }
  var val = $("#in").val();
  localStorage[cur] = val;
  $("#" + cur).text(getName(val));
}

function load(cur) {
  $('.doc').removeClass('cur');
  var val = localStorage[cur];
  if (val) {
    localStorage[CURRENT] = cur;
    $("#in").val(val);
    xform();
    $("#in").scrollTop(0);
    $("#out").scrollTop(0);
    $("#"+cur).addClass('cur');
  }
}

function getName(doc) {
  var m = doc.match(/^\s*docname:\s*(\S+)/mi);
  if (m) {
    return m[1];
  }
  return '';
}

function addDocName(id, text) {
  return $("<div class='doc' id='" + id + "'>" + getName(text) + "</div>").appendTo("#list");
}

function loadText(txt) {
  var cur = DOC_PREFIX + new Date().getTime().toString(16);
  $('#in').val(txt);
  addDocName(cur, txt).addClass('cur');
  save(cur);
}

function newDoc() {
  $('.doc').removeClass('cur');

  var def = localStorage[DEFAULT_DOC];
  if (def) {
    loadText(def);
  } else {
    // Populate a minimal mkd file in the input
    $.ajax({
      url: DEFAULT_DOC_URL,
      type: "get",
      dataType: "text",
      success: function(response) {
        localStorage[DEFAULT_DOC] = response;
        loadText(response);
      }
    });
  }
}

$(document).ready(function() {
  // Attach the compile action to the button
  $("#go").click(xform)

  $("a.download").click(function() {
    // Update the content
    window.state.mkd = $("#in").val();
    window.state.name = getName(window.state.mkd);

    // Populate the form
    var id = $(this)[0].id;
    var content = $("#downloadContent")[0];
    var format = $("#downloadFormat")[0];
    var name = $("#downloadName")[0];
    if (id.indexOf("mkd") == 0) {
      content.value = window.state.mkd;
      format.value = "mkd";
      name.value = window.state.name + ".mkd";
    } else if (id.indexOf("xml") == 0) {
      content.value = window.state.xml;
      format.value = "xml";
      name.value = window.state.name + ".xml";
    } else if (id.indexOf("txt") == 0) {
      content.value = window.state.txt;
      format.value = "txt";
      name.value = window.state.name + ".txt";
    } else {
      return; // wat
    }

    // Submit the form
    $("#dlForm").submit();
  })

  $("#plus").click(newDoc);
  $("#minus").click(function() {
    // TODO: replace this with something prettier
    if (!confirm('OK to delete?')) {
      return;
    }
    var n = $('.cur').next();
    if (n.length === 0) {
      n = $('.cur').prev();
    }
    $('.cur').remove();
    var cur = localStorage[CURRENT];
    delete localStorage[cur];
    if (n.length>0) {
      cur = n[0].id;
      load(cur);
    } else {
      newDoc();
    }
  });

  // Automatically run the transform after a keypress, throttled with a timer.
  $("#in").keyup(function() {
    if (state.timer) {
      clearTimeout(state.timer);
    }
    state.timer = setTimeout(function(){
      state.timer = null;
      save();
    }, SAVE_TIMEOUT);
  });

  $('#list').on('click', '.doc', function(evt){
    var cur = evt.target.id;
    save();
    load(cur);
  })

  // Put all of the known documents into the document list
  $.each(localStorage, function(key, value){
    if (key.match(IS_DOC)) {
      addDocName(key, value);
    }
  });

  // Initial load.  Default to last current document.
  var cur = localStorage[CURRENT];
  if (cur) {
    load(cur);
  } else {
    newDoc();
  }
});
</script>
<style>

html { height: 95%; }

body {
  background: #ECF0F1;
  font-family: Menlo, Courier, monospace;
  font-size: 12px;
  height: 95%;
  margin: 0
}

#container{
  margin: 1em auto;
  text-align: center;
  height: 95%;
}

#docs{
  float: left;
  margin-top: 10px;
  margin-left: 10px;
  width: 10%;
}

#list {
  clear:both;
  padding: 2px;
}

.doc {
  margin-bottom: 10px;
  border-top: 1px solid black;
}

.cur {
  background: black;
  color: white;
}

textarea {
  width: 40%;
  float: left;
  height: 95%;
  background: #ECF0F1;
  border: 1px solid #BDC3C7;
  font-family: Menlo, Courier, monospace;
  font-size: 12px;
}

button {
  color: white;
  background: #8E44AD;
  border: none;
  font-family: Menlo, Courier, monospace;
  font-size: 12px;
  font-weight: bold;
}

.topButton {
  width: 80ex;
  padding: 1ex;
}

.sideButton {
  width: 2em;
  height: 2em;
  text-align: center;
  margin: 2px;
  float: left;
}

a {
  width: 80ex;
  color: white;
  background: #2980B9;
  border: none;
  padding: 2ex;
  font-family: Menlo, Courier, monospace;
  font-size: 12px;
  font-weight: bold;
  text-decoration: none;
}

form {
  display: none;
}

#forkme {
  display: block;
  float: left;
  background: #3498DB;
  color: #ECF0F1;
  margin: 0;
}

#forkme a {
  text-decoration: none
  color: inherit;
}

#forkme a i {
  font-size: 150%;
}

</style>
<!-- Github icon font -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>

<div id="forkme">
  <a href="https://github.com/draftr-js/draftr-js.github.io">
    <i class="fa fa-code-fork"></i> me on <i class="fa fa-github"></i>
  </a>
</div>

<!-- Main markup section -->
<div id="container">
<button id="go" class="topButton">markdown --&gt; rfc</button><br/>
<div id="docs">
  <button id="plus" class="sideButton" title="Add Document">+</button>
  <button id="minus" class="sideButton" title="Remove Current Document">-</button>
  <div id="list">
  </div>
</div>
<textarea id="in"></textarea>
<textarea id="out"></textarea>

<!-- TODO: re-enable file downloads -->
<!--
<p>
  <a href="#" class="download" id="mkdDownload" title="Download Markdown">&darr;M</a>
  <a href="#" class="download" id="xmlDownload" title="Download XML">&darr;X</a>
  <a href="#" class="download" id="txtDownload" title="Download text/RFC">&darr;T</a>
  <a href="https://github.com/cabo/kramdown-rfc2629" target="_blank" title="Help">H?</a>
</p>
<form id="dlForm" action="download.py" method="post" target="blank">
  <input type="hidden" id="downloadContent" name="content"/>
  <input type="hidden" id="downloadFormat" name="format"/>
  <input type="hidden" id="downloadName" name="name"/>
</form>
-->
</div>

</body>
</html>
